 ---
ğŸ” FHE Single Player â†’ Multiplayer Analizi

Mevcut Single Player Mimarisi

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SINGLE PLAYER FHE FLOW                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  CLIENT (Browser)              SERVER (Node.js)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ FHEGameSession â”‚â—„â”€â”€socketâ”€â”€â–ºâ”‚ single_player.coffee â”‚     â”‚
â”‚  â”‚ - wallet     â”‚              â”‚ - games{}            â”‚      â”‚
â”‚  â”‚ - deck[]     â”‚              â”‚ - session            â”‚      â”‚
â”‚  â”‚ - myHand[]   â”‚              â”‚ - FHE handlers       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ TX                                                 â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ GameSession.sol â”‚ â† 40 FHE.rand() encrypted indices      â”‚
â”‚  â”‚ - 1 player   â”‚                                           â”‚
â”‚  â”‚ - 1 deck     â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mevcut Flow:
1. Client: createSinglePlayerGame(gameId) â†’ 40 encrypted random index
2. Client: getDrawHandles(5) â†’ encrypted handles
3. Client: ZAMA KMS publicDecrypt() â†’ clear indices
4. Client: revealDrawBatch() â†’ verify proof on-chain
5. Client â†’ Server: fhe_initial_hand_revealed (kartlarÄ± bildir)
6. Server: SDK'da kartlarÄ± el'e ekle

  ---
Multiplayer Ä°Ã§in Gerekli DeÄŸiÅŸiklikler

1. Contract DeÄŸiÅŸikliÄŸi (ZORUNLU)

// MEVCUT - sadece 1 oyuncu
struct Game {
address player;        // TEK oyuncu
uint8 currentTurn;
...
}

// YENÄ° - 2 oyuncu
struct MultiplayerGame {
address player1;
address player2;
uint8 currentTurn;
uint8 activePlayer;    // 1 veya 2
...
}

// MEVCUT - 40 index (1 deck)
mapping(uint256 => mapping(uint8 => euint8)) private drawIndices;

// YENÄ° - 80 index (2 deck)
mapping(uint256 => mapping(uint8 => mapping(uint8 => euint8))) private drawIndices;
// drawIndices[gameId][playerId][cardIndex]

Yeni Fonksiyonlar:
- createMultiplayerGame(gameId, player1, player2) â†’ 80 FHE.rand (2x40)
- getDrawHandlesForPlayer(gameId, playerId, count) â†’ Sadece kendi deck'inden
- revealDrawBatchForPlayer(gameId, playerId, ...) â†’ Player-specific reveal

2. Server DeÄŸiÅŸikliÄŸi (game.coffee)

# MEVCUT (single_player.coffee - satÄ±r 139-147)
socket.on "fhe_game_created", onFHEGameCreated
socket.on "fhe_initial_hand_revealed", onFHEInitialHandRevealed
socket.on "fhe_card_drawn", onFHECardDrawn

# YENÄ° (game.coffee'ye eklenmeli)
# AynÄ± handler'lar AMA:
# - 2 oyuncu iÃ§in ayrÄ± deck state
# - Her oyuncunun reveal'Ä±nÄ± AYRI takip
# - Ä°kisi de reveal edince oyun baÅŸlar

Multiplayer FHE State:
games[gameId].fhe = {
enabled: true                                                                                                                                                                                                                                                                                                   
player1: {
deck: []
revealedIndices: []
handReady: false                                                                                                                                                                                                                                                                                              
}
player2: {
deck: []
revealedIndices: []
handReady: false                                                                                                                                                                                                                                                                                              
}
}

3. Client DeÄŸiÅŸikliÄŸi (fheGameSession.js)

// MEVCUT - tek deck                                                                                                                                                                                                                                                                                              
this.deck = [];
this.myHand = [];

// YENÄ° - opponent deck gÃ¶rÃ¼nmez ama state'i var                                                                                                                                                                                                                                                                  
this.myDeck = [];
this.myHand = [];
this.opponentHandSize = 0;  // Sadece sayÄ± (kartlar ÅŸifreli)

  ---
Zorluk DeÄŸerlendirmesi

| BileÅŸen                    | Zorluk   | Neden                                         |
  |----------------------------|----------|-----------------------------------------------|
| Contract                   | ğŸŸ¡ ORTA  | 80 FHE.rand = 2x gas, yeni struct/mapping     |
| Server (game.coffee)       | ğŸŸ¢ KOLAY | Handler'larÄ± kopyala, 2 oyuncu iÃ§in adapte et |
| Client (fheGameSession.js) | ğŸŸ¢ KOLAY | Tek deÄŸiÅŸiklik: playerId parametre ekle       |
| Senkronizasyon             | ğŸ”´ ZOR   | Ä°ki oyuncu reveal zamanlama sorunu            |

  ---
Kritik Sorular

1. Ä°ki oyuncu aynÄ± anda mÄ± reveal edecek?
- Paralel: Her ikisi de kendi initial hand'ini baÄŸÄ±msÄ±z reveal â†’ daha hÄ±zlÄ±
- SÄ±ralÄ±: Ã–nce player1, sonra player2 â†’ daha basit

2. Turn geÃ§iÅŸi nasÄ±l olacak?
   Turn 1: Player1 oynar â†’ end turn
   Player1 deck'ten 1 kart Ã§eker (FHE reveal)
   Player2'ye geÃ§er
   Turn 2: Player2 oynar â†’ end turn
   Player2 deck'ten 1 kart Ã§eker (FHE reveal)
   Player1'e geÃ§er
   ...

3. Opponent kartlarÄ±nÄ± gÃ¶rmeme:
- Her oyuncu SADECE kendi drawIndices'ini decrypt edebilir
- ACL: FHE.allow(drawIndices[gameId][1][i], player1) â†’ sadece player1 gÃ¶rebilir
- Bu FHE'nin doÄŸal Ã¶zelliÄŸi - built-in gÃ¼venlik

  ---
Ã–nerilen Yol

1. Contract gÃ¼ncelle:
    - createMultiplayerGame()
    - Player-specific reveal functions
    - 80 FHE.rand (daha fazla gas!)

2. game.coffee'ye FHE handler'larÄ± ekle:
    - single_player.coffee'den kopyala
    - 2 oyuncu state'i iÃ§in adapte et
    - "Her iki oyuncu da ready" kontrolÃ¼

3. Client'ta minimal deÄŸiÅŸiklik:
    - playerId parametresi ekle
    - Opponent hand size tracking

4. Test:
    - Ä°ki browser ile test (farklÄ± wallet)
    - Timing/sync sorunlarÄ± iÃ§in edge case'ler

  ---
SonuÃ§

Ne kadar zor?

- Kod miktarÄ±: ~500-800 satÄ±r yeni/deÄŸiÅŸiklik
- KarmaÅŸÄ±klÄ±k: Orta (en zor kÄ±sÄ±m 2-player sync)
- Risk: Gas limitleri (80 FHE.rand = ~16M gas, Sepolia'da sorun olabilir)

Evet, baÄŸÄ±msÄ±z single player gibi olacaksÄ±nÄ±z - herkes kendi deck'ini reveal eder, server coordinator. Multiplayer'da "hile" mÃ¼mkÃ¼n deÄŸil Ã§Ã¼nkÃ¼ kimse opponent'Ä±n ÅŸifreli kartlarÄ±nÄ± decrypt edemez.
# FHEIGHT fhEVM Integration

Complete technical documentation for Fully Homomorphic Encryption integration in FHEIGHT. This guide follows the game flow from start to finish - someone reading this should understand exactly how the system works step by step.

---

## Table of Contents

1. [File References](#1-file-references)
2. [Wallet Manager](#2-wallet-manager)
3. [FHE Session Security](#3-fhe-session-security)
4. [FHE Client Setup](#4-fhe-client-setup)
5. [CardRegistry Integration](#5-cardregistry-integration)
6. [Game Session Flow](#6-game-session-flow)
7. [Initial Hand Reveal](#7-initial-hand-reveal)
8. [Turn System and Card Draw](#8-turn-system-and-card-draw)
9. [Replace Card and Skill-Based Card Draw](#9-replace-card-and-skill-based-card-draw)
10. [UI State Management](#10-ui-state-management)
11. [Multiplayer Synchronization](#11-multiplayer-synchronization)
12. [Boss Battle Integration](#12-boss-battle-integration)
13. [Marble System (Booster Packs)](#13-marble-system-booster-packs)
14. [Error Handling and Retry](#14-error-handling-and-retry)
15. [Security Model](#15-security-model)

---

## 1. File References

### Client Files

| File | Path | Purpose |
|------|------|---------|
| deck_select.js | app/ui/views/composite/ | Play button, FHE game initialization |
| games_manager.js | app/ui/managers/ | Matchmaking with FHE data |
| fheGameSession.js | app/sdk/fhe/ | FHE client module, blockchain operations |
| fhe.js | app/common/ | FHE utilities |
| wallet.js | app/common/ | MetaMask connection |
| game.js | app/ui/views2/layouts/ | Game UI, card display |
| game_bottom_bar.js | app/ui/views/composite/ | Submit/Decrypt buttons |
| game_choose_hand.js | app/ui/views/item/ | Initial hand UI |
| application.js | app/ | Game start functions |

### Server Files

| File | Path | Purpose |
|------|------|---------|
| single_player.coffee | server/ | Single player game handler |
| game.coffee | server/ | Multiplayer game handler |
| blockchain.coffee | server/lib/ | Contract view calls |
| fhe_marble_verifier.coffee | server/lib/ | Marble card calculation |
| creategame.coffee | worker/ | Game creation worker |
| gameSetup.js | app/sdk/ | Deck setup, FHE deck order |
| matchmaker.coffee | server/routes/ | Matchmaking with FHE tokens |
| r-tokenmanager.coffee | server/redis/ | Token storage with FHE fields |
| inventory.coffee | server/lib/data_access/ | Marble inventory operations |

### Contract Files

| File | Path | Purpose |
|------|------|---------|
| GameSession.sol | fhevm-contracts/contracts/ | In-game FHE random generation |
| MarbleRandoms.sol | fhevm-contracts/contracts/ | Booster pack FHE random |
| CardRegistry.sol | fhevm-contracts/contracts/ | On-chain card metadata |
| WalletVault.sol | fhevm-contracts/contracts/ | Encrypted session key storage |

---

## 2. Wallet Manager

The Wallet Manager is the entry point for all blockchain interactions.

### Connection Flow

```
User                    Wallet Manager              MetaMask
  |                           |                          |
  |                           |                          |
  | 1. Click "Connect"        |                          |
  +-------------------------->|                          |
  |                           |                          |
  |                           |                          |
  |                           | 2. eth_requestAccounts   |
  |                           +------------------------->|
  |                           |                          |
  |                           |                          |
  |                           |         3. User approves |
  |                           |<-------------------------+
  |                           |                          |
  |                           |                          |
  | 4. Connected              |                          |
  |<--------------------------+                          |
  |                           |                          |
  |                           |                          |
  | 5. Initialize Session Wallet                         |
  +-------------------------->|                          |
  |                           |                          |
  |                           |                          |
```

### Wallet State Table

| State | Description | Next Action |
|-------|-------------|-------------|
| `disconnected` | No wallet connected | Show connect button |
| `connecting` | Awaiting user approval | Show spinner |
| `connected` | Main wallet ready | Initialize Session Wallet |
| `error` | Connection failed | Show retry option |

---

## 3. FHE Session Security

The FHE session stores the Zama reencryption keypair - a ML-KEM keypair generated by fhevmjs SDK for Gateway communication.

### What Gets Stored

| Component | Storage Location | Encryption |
|-----------|------------------|------------|
| Zama reencryption keypair (ML-KEM) | LocalStorage | AES-256-GCM with PIN |
| EIP712 signature | LocalStorage | AES-256-GCM with PIN |
| Contract addresses | LocalStorage | AES-256-GCM with PIN |
| Session expiry | LocalStorage | Unencrypted (for quick TTL check) |

### Lifecycle

```
GENERATION --> SIGNATURE --> ENCRYPTION --> STORAGE --> RECOVERY
     |              |             |             |            |
     |              |             |             |            |
fhevmjs.       MetaMask      PIN input    LocalStorage   Game start
generateKeypair EIP712        AES-256      encrypted      PIN prompt
(ML-KEM)       popup          encrypt      + TTL          decrypt to RAM
```

### PIN Encryption Parameters

| Parameter | Value | Purpose |
|-----------|-------|---------|
| Algorithm | AES-256-GCM | Authenticated encryption |
| Key Derivation | PBKDF2-SHA256 | PIN to key conversion |
| Iterations | 100,000 | Brute-force protection |
| Salt Size | 16 bytes | Unique per encryption |
| IV Size | 12 bytes | GCM standard |
| TTL | 24 hours | Auto-expiry |

### Storage Structure

```javascript
// LocalStorage key: 'fheight_fhe_session'
localStorage['fheight_fhe_session'] = {
    encrypted: "base64...",   // AES-encrypted session data
    salt: "base64...",        // PBKDF2 salt
    iv: "base64...",          // AES-GCM IV
    expiry: 1703209856789,    // TTL timestamp (unencrypted)
    version: 2                // PIN-encrypted version
}

// Decrypted session data contains:
{
    publicKey: Uint8Array,    // ML-KEM public key (fhevmjs)
    privateKey: Uint8Array,   // ML-KEM private key (fhevmjs)
    signature: "0x...",       // EIP712 signature from MetaMask
    contractAddresses: [],    // Authorized contract addresses
    startTime: 1703123456789,
    expiry: 1703209856789
}
```

### Session Recovery Conditions

| Condition | If TRUE | If FALSE |
|-----------|---------|----------|
| `localStorage['fheight_fhe_session'] exists` | Read blob | Generate new keypair |
| `now < expiry` | Use existing session | Request new PIN |
| `decryption succeeds` | Load to memory | Show "Wrong PIN" |
| `memory.keypair exists` | Skip PIN prompt | Request PIN |

---

## 4. FHE Client Setup

The FHE client (fhevmjs) handles encrypted operations with Zama Gateway.

### Initialization Flow

```
Session Wallet Ready
        |
        |
        v
+------------------+
| Create fhevmjs   |
| Instance         |
+------------------+
        |
        |
        v
+------------------+
| Fetch Network    |
| FHE Public Key   |
+------------------+
        |
        |
        v
+------------------------+
| Generate Reencryption  |
| Keypair (for Gateway)  |
| fhevmjs.generateKeypair|
+------------------------+
        |
        |
        v
+------------------------+
| Sign Keypair with      |
| Session Wallet (EIP712)|
+------------------------+
        |
        |
        v
+------------------+
| FHE Ready        |
+------------------+
```

**Reencryption Keypair:** This is NOT the session wallet keypair. It's a separate keypair generated by fhevmjs specifically for Gateway communication. The Gateway uses this to verify that the requesting address is authorized to decrypt the value.

### FHE Operations Used

| Operation | Function | Purpose |
|-----------|----------|---------|
| Random Generation | `FHE.randEuint8()` | Generate encrypted random 0-255 |
| External Input | `FHE.fromExternal()` | Accept client-encrypted value |
| Self Permission | `FHE.allowThis()` | Contract can use value |
| User Permission | `FHE.allow()` | Address can decrypt value |
| Public Decrypt | `FHE.makePubliclyDecryptable()` | Gateway can decrypt |
| Handle Convert | `FHE.toBytes32()` | Convert for verification |
| Proof Verify | `FHE.checkSignatures()` | Verify decryption proof |

---

## 5. CardRegistry Integration

CardRegistry stores all card metadata on-chain, ensuring card attributes cannot be tampered with.

### Architecture

```
+-------------------+
|   CardRegistry    |
+-------------------+
|                   |
| Card Attributes:  |
| - cardId          |
| - name            |
| - faction         |
| - rarity          |
| - attack          |
| - health          |
| - manaCost        |
| - abilities[]     |
|                   |
+--------+----------+
         |
         | getCard(cardId)
         | 
         v
+-------------------+         +-------------------+
|   GameSession     |         |  MarbleRandoms    |
|-------------------|         |-------------------|
| On card draw:     |         | On pack open:     |
| 1. FHE random     |         | 1. FHE randoms    |
| 2. Map to cardId  |         | 2. Rarity calc    |
| 3. Fetch metadata |         | 3. Select from    |
| 4. Verify attrs   |         |    CardRegistry   |
+-------------------+         +-------------------+
```

### Card Pool Lookup

```javascript
// Server and Client use same SDK for card lookup
var cardPool = SDK.GameSession.getCardCaches()
    .getCardSet(cardSetId)        // Core, Expansion, etc.
    .getRarity(rarityType)        // Common, Rare, Epic, Legendary
    .getIsCollectible(true)
    .getIsPrismatic(false)
    .getCardIds();

// Map FHE random to card
var selectedIndex = randomValue % cardPool.length;
var cardId = cardPool[selectedIndex];
```

---

## 6. Game Session Flow

### Phase 1: Game Creation

```
KULLANICI                  CLIENT                    SERVER                   CONTRACT
    |                         |                         |                         |
    |                         |                         |                         |
    | 1. Play butonuna basar  |                         |                         |
    +------------------------>|                         |                         |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         | 2. Wallet + PIN check   |                         |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         +-------+                 |                         |
    |                         |       |                 |                         |
    |                         |       |                 |                         |
    |                         |<------+                 |                         |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         | 3. createSinglePlayerGame(gameId)                 |
    |                         +-------------------------------------------------->|
    |                         |                         |                         |
    |                         |                         |                         |
    |                         |                         |                         | 4. 40x FHE.randEuint8()
    |                         |                         |                         |    Store encrypted
    |                         |                         |                         |    emit GameCreated
    |                         |                         |                         |
    |                         |                         |                         |
    |                         | 5. TX confirmed         |                         |
    |                         |<--------------------------------------------------+
    |                         |                         |                         |
    |                         |                         |                         |
    |                         | 6. Matchmaking request  |                         |
    |                         | POST /matchmaking       |                         |
    |                         | { fhe_enabled: true,    |                         |
    |                         |   fhe_game_id: gameId } |                         |
    |                         +------------------------>|                         |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         |                         | 7. Create game session  |
    |                         |                         |    fheDeckOrder = deck  |
    |                         |                         |    startingHandSize = 0 |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         | 8. Game ready           |                         |
    |                         |<------------------------+                         |
    |                         |                         |                         |
    |                         |                         |                         |
    |                         |                         |                         |
```

### Server Game State Setup

```coffeescript
# creategame.coffee
if player1FheEnabled
  player1DataForGame.fhePlayer = true
  player1DataForGame.startingHandSize = 0  # Hand is empty, cards from FHE

# game.coffee
games[gameId].fhe = {
  player1: {
    enabled: true
    blockchainGameId: data.blockchainGameId
    revealedCount: 0
    initialHandRevealComplete: false
    turnDrawComplete: true  # Starts true
  }
}
```

---

## 7. Initial Hand Reveal

### Flow (5 Cards)

```
CLIENT                    CONTRACT                   GATEWAY                  SERVER
   |                            |                        |                       |
   |                            |                        |                       |
   | 1. getDrawHandles(gameId, 5)                        |                       |
   +--------------------------->|                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |    bytes32[5] handles      |                        |                       |
   |<---------------------------+                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 2. publicDecrypt(handles)  |                        |                       |
   +---------------------------------------------------->|                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |    clearIndices = [17, 3, 29, 8, 12]                |                       |
   |    + decryptionProof       |                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |<----------------------------------------------------+                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 3. Calculate cards locally |                        |                       |
   |                            |                        |                       |
   +---+                        |                        |                       |
   |   |                        |                        |                       |
   |   | remaining = deck.slice()                        |                       |
   |   | for each idx:          |                        |                       |
   |   |   pos = idx % remaining.length                  |                       |
   |   |   hand.push(remaining[pos])                     |                       |
   |   |   remaining.splice(pos, 1)                      |                       |
   |<--+                        |                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 4. revealDrawBatch(gameId, clearIndices, proof)     |                       |
   +--------------------------->|                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |                            | FHE.checkSignatures()  |                       |
   |                            | if valid: store        |                       |
   |                            | emit DrawRevealed      |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |    TX confirmed            |                        |                       |
   |<---------------------------+                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 5. socket.emit("fhe_initial_hand_revealed")         |                       |
   +---------------------------------------------------------------------------->|
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |                        |     6. VERIFY         |
   |                            |<-----------------------------------------------+
   |                            |                        |                       |
   |                            |                        | getVerifiedDrawOrder()|
   |                            |                        |                       |
   |                            +----------------------------------------------->|
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |                        |     7. Same algorithm |
   |                            |                        |        Apply to SDK   |
   |                            |                        |                       |
   |                            |                        |                       |
   | 8. fhe_initial_hand_revealed_response               |                       |
   |<----------------------------------------------------------------------------+
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
```

### Card Selection Algorithm

```javascript
// Both client and server use IDENTICAL algorithm
function calculateCardsFromIndices(deck, indices) {
    var remaining = deck.slice();  // Copy of deck
    var cards = [];

    for (var i = 0; i < indices.length; i++) {
        var pos = indices[i] % remaining.length;
        cards.push(remaining[pos]);
        remaining.splice(pos, 1);  // Remove from remaining
    }

    return {
        drawnCards: cards,
        remainingDeck: remaining
    };
}
```

---

## 8. Turn System and Card Draw

### Turn End Flow (Multiplayer Critical)

```
Player1 (Ending Turn)              SERVER                    Player2
         |                            |                          |
         |                            |                          |
         | 1. EndTurnAction           |                          |
         +--------------------------->|                          |
         |                            |                          |
         |                            |                          |
         |                            | 2. onStep(EndTurnAction) |
         |                            |    turnDrawComplete = false
         |                            |    emit EndTurnAction    |
         |                            +------------------------->|
         |                            |                          |
         |                            |                          |
         |                            | 3. onStep(StartTurnAction)
         |                            | if (!turnDrawComplete)   |
         |                            |   pendingStartTurnStep = step
         |                            |   DO NOT EMIT!           |
         |                            |                          |
         |                            |                          |
         | 4. incrementTurn TX        |                          |
         |                            |                          |
         +---+                        |                          |
         |   |                        |                          |
         |   | getDrawHandles(1)      |                          |
         |   | publicDecrypt          |                          |
         |   | revealDrawBatch        |                          |
         |<--+                        |                          |
         |                            |                          |
         |                            |                          |
         | 5. fhe_card_drawn          |                          |
         +--------------------------->|                          |
         |                            |                          |
         |                            |                          |
         |                            | 6. Blockchain verify     |
         |                            |    Apply card to SDK     |
         |                            |    turnDrawComplete = true
         |                            |                          |
         |                            |                          |
         |                            | 7. NOW emit pending step |
         |                            +------------------------->|
         |                            |                          |
         |                            |                          |
         |                            |    restartTurnTimer()    |
         |                            |                          |
         |                            |                          |
         | 8. fhe_card_drawn_response |                          |
         |<---------------------------+                          |
         |                            |                          |
         |                            |                          |
         |                            |           9. Now can play|
         |                            |                          |
         |                            |                          |
         |                            |                          |
```

### Why StartTurnAction is Held

| Problem | Solution |
|---------|----------|
| Player2 receives turn before Player1 finishes FHE decrypt | Hold StartTurnAction until decrypt complete |
| stepCount desync between client and server | Subtract 1 from stepCount while pending |
| Player2 plays before game state is consistent | Emit StartTurnAction only after verification |

### Pending Step Logic

```coffeescript
# game.coffee - onStep()

if action instanceof SDK.EndTurnAction
  # Mark ending player as "drawing"
  endingPlayerFhe = getFHEStateForPlayer(gameId, action.getOwnerId())
  if endingPlayerFhe?.enabled
    endingPlayerFhe.turnDrawComplete = false

if action instanceof SDK.StartTurnAction
  # If ending player hasn't finished FHE draw, hold this step
  if endingPlayerFhe?.enabled and not endingPlayerFhe.turnDrawComplete
    game.pendingStartTurnStep = stepEventData
    return  # DO NOT emit

# game.coffee - onFHECardDrawn()
fheState.turnDrawComplete = true
if game.pendingStartTurnStep?
  emitGameEvent(null, gameId, game.pendingStartTurnStep)
  game.pendingStartTurnStep = null
  restartTurnTimer(gameId)
```

---

## 9. Replace Card and Skill-Based Card Draw

Card abilities that draw or replace cards also use FHE to ensure fair random selection.

### Replace Card Flow

When a player replaces a card from hand:

```
CLIENT                    FHECardHandler            CONTRACT                  SERVER
   |                            |                        |                       |
   |                            |                        |                       |
   | 1. ReplaceCardFromHandAction(slot)                  |                       |
   +--------------------------->|                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |                            | 2. replaceCard(slot)   |                       |
   |                            +----------------------->|                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |           3. Get next FHE random               |
   |                            |              Map to deck card                  |
   |                            |              Return new handle                 |
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |    4. Decrypt via KMS  |                       |
   |                            |<-----------------------+                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |                            | 5. Calculate new card  |                       |
   |                            |                        |                       |
   |                            +-------+                |                       |
   |                            |       |                |                       |
   |                            |       |                |                       |
   |                            |<------+                |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   |  6. New card ID            |                        |                       |
   |<---------------------------+                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 7. Update hand UI          |                        |                       |
   |                            |                        |                       |
   +-------+                    |                        |                       |
   |       |                    |                        |                       |
   |       |                    |                        |                       |
   |<------+                    |                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
   | 8. Notify server           |                        |                       |
   +---------------------------------------------------------------------------->|
   |                            |                        |                       |
   |                            |                        |                       |
   |                            |                        |                       |
```

### FHE Card Handler Integration

```javascript
// FHECardHandler intercepts card actions

// Replace card with FHE
FHECardHandler.replaceCard = function(handSlot) {
    return fheGameSession.replaceCard(handSlot);
};

// Draw card via ability (e.g., "Draw a random minion")
FHECardHandler.drawCard = function(gameSession, playerId) {
    return fheGameSession.drawCard()
        .then(function(decryptedHand) {
            var newCardId = decryptedHand[decryptedHand.length - 1];
            return {
                cardId: newCardId,
                index: decryptedHand.length - 1,
                fromFHE: true
            };
        });
};
```

### Card Abilities Using FHE

| Ability Type | FHE Integration | Example Cards |
|--------------|-----------------|---------------|
| Replace | Uses next FHE random from pool | Manual replace, Aethermaster |
| Draw from deck | Consumes FHE random for index | Spelljammer, Blaze Hound |
| Draw random type | FHE random + type filter | Draw random Arcanyst |
| Put card in hand | FHE random for card selection | Dying wish abilities |
| Transform hand | FHE randoms for each card | Mnemovore effect |

### PutCardInHandAction FHE Flow

When a card ability puts a specific card type in hand:

```
Ability Trigger                  FHECardHandler              CONTRACT
       |                               |                         |
       |                               |                         |
       | 1. PutCardInHandAction        |                         |
       |    (cardType: "Arcanyst")     |                         |
       +------------------------------>|                         |
       |                               |                         |
       |                               |                         |
       |                               | 2. Get card pool        |
       |                               |    by type filter       |
       |                               |                         |
       |                               +-------+                 |
       |                               |       |                 |
       |                               |       |                 |
       |                               |<------+                 |
       |                               |                         |
       |                               |                         |
       |                               | 3. Request FHE random   |
       |                               +------------------------>|
       |                               |                         |
       |                               |                         |
       |                               |      4. euint8 handle   |
       |                               |<------------------------+
       |                               |                         |
       |                               |                         |
       |                               | 5. Decrypt              |
       |                               +------------------------>|
       |                               |                         |
       |                               |                         |
       |                               |      6. Value (0-255)   |
       |                               |<------------------------+
       |                               |                         |
       |                               |                         |
       |                               | 7. Select card          |
       |                               |    value % pool.length  |
       |                               |                         |
       |                               +-------+                 |
       |                               |       |                 |
       |                               |       |                 |
       |                               |<------+                 |
       |                               |                         |
       |                               |                         |
       | 8. Card added to hand         |                         |
       |<------------------------------+                         |
       |                               |                         |
       |                               |                         |
       |                               |                         |
```

### Skill Events with FHE

```javascript
// Lazy decryption for hand visibility
FHECardHandler.decryptCard = function(handSlot) {
    if (pendingDecrypts.has(handSlot)) {
        return pendingDecrypts.get(handSlot);
    }

    var decryptPromise = decryptHand()
        .then(function(hand) {
            pendingDecrypts.delete(handSlot);
            return hand[handSlot];
        });

    pendingDecrypts.set(handSlot, decryptPromise);
    return decryptPromise;
};

// Event listeners for card operations
FHECardHandler.onCardDrawn = function(callback) {
    fheGameSession.on('CardDrawn', function(gameId, playerIndex) {
        callback({ gameId: gameId, playerIndex: playerIndex });
    });
};

FHECardHandler.onCardPlayed = function(callback) {
    fheGameSession.on('CardPlayed', function(gameId, playerIndex, cardId, x, y) {
        callback({ gameId: gameId, cardId: cardId, x: x, y: y });
    });
};
```

---

## 10. UI State Management

### Submit/Continue Button States

```
+-------------------+      +-------------------+      +-------------------+
|    My Turn        | ---> |   Submitting      | ---> |  Enemy Turn       |
|                   |      |                   |      |                   |
| "Submit Proof"    |      | "Submitting"      |      | "Verifying..."    |
| button.my-turn    |      | button.submitting |      | button.enemy-turn |
|                   |      |                   |      |                   |
+-------------------+      +-------------------+      +-------------------+
           ^                                                    |
           |                                                    |
           |                                                    |
           +----------------------------------------------------+
                       (when your turn starts again)
```

### _fheSubmitting Flag

```javascript
// game_bottom_bar.js

onClickSubmitTurn: function () {
    if (fheEnabled) {
        this._fheSubmitting = true;  // SET FLAG
        this._setSubmitTurnButtonToSubmittingState();
    }
    gameSession.submitExplicitAction(EndTurnAction);
}

_updateSubmitTurnState: function () {
    if (this._fheSubmitting) {
        return;  // IGNORE SDK events while submitting
    }
    // normal state logic
}

_setSubmitTurnButtonToEnemyState: function () {
    if (this._fheSubmitting) {
        return;  // IGNORE - keep showing "Submitting"
    }
    // show "Verifying Opponent"
}

_onFHEDecryptSuccess: function () {
    this._fheSubmitting = false;  // CLEAR FLAG
    this._updateSubmitTurnState();  // Now update normally
}
```

### Initial Hand Continue Button

```javascript
// game_choose_hand.js

onRender: function () {
    if (fheEnabled) {
        // Hide Continue button until decrypt complete
        this.ui.$confirmButton.css({
            opacity: 0,
            'pointer-events': 'none',
        });
    }
}

setConfirmButtonVisibility: function (visible) {
    if (visible) {
        this.ui.$confirmButton.css({
            opacity: '',
            'pointer-events': '',
        });
    }
}
```

---

## 11. Multiplayer Synchronization

### Server Dual Role

```
+-------------------------------------------------------------------+
|                         SERVER ROLES                              |
+-------------------------------------------------------------------+
|                                                                   |
|   SYNC (Coordinator)                OBSERVE (Verifier)            |
|   -----------------------           -----------------------       |
|   - Match players                   - Listen contract events      |
|   - Manage turn order               - Read verified values        |
|   - Relay actions                   - Cross-check state           |
|   - Handle disconnects              - Never generate randoms      |
|   - Timeout management              - Never decrypt values        |
|                                                                   |
+-------------------------------------------------------------------+
```

### Trust Model

```
+-------------------------------------------------------------------+
|                        TRUSTED ZONE                               |
+-------------------------------------------------------------------+
|   BLOCKCHAIN (Smart Contract)       ZAMA GATEWAY (KMS)            |
|   - FHE random generation           - Threshold decryption        |
|   - Proof verification              - Only for authorized users   |
+-------------------------------------------------------------------+
                     |                        |
                     |                        |
                     v                        v
+-------------------------------------------------------------------+
|                      UNTRUSTED ZONE                               |
+-------------------------------------------------------------------+
|   CLIENT                            SERVER                        |
|   - Signs TX                        - Coordinates players         |
|   - Requests decrypt                - Reads blockchain            |
|   - Calculates cards                - Verifies state              |
|   All critical operations verified on-chain                       |
+-------------------------------------------------------------------+
```

### Why Server Cannot Cheat

| Attack | Why It Fails |
|--------|--------------|
| Server sends fake card | Client verifies on-chain handle |
| Server modifies random | Proof verification fails |
| Server replays old game | Unique on-chain gameId |
| Server favors player | All randoms from FHE coprocessor |

---

## 12. Boss Battle Integration

Boss Battle uses the same FHE system as Single Player with different AI configuration.

### Difference Table

| Aspect | Single Player | Boss Battle |
|--------|---------------|-------------|
| Endpoint | `/api/me/games/single_player` | `/api/me/games/boss_battle` |
| AI Difficulty | Dynamic (win count) | Fixed (1.0 - max) |
| AI Deck | Random | Boss-specific (GameSetups) |
| GameType | `SDK.GameType.SinglePlayer` | `SDK.GameType.BossBattle` |
| Button Text | "Encrypt & Fight" | "BOSS FHEIGHT" |

### Boss Battle FHE Flow

```
deck_select_boss_battle.js: getConfirmSelectionEvent()
    |-- return EVENTS.start_boss_battle
    v
application.js: _startBossBattleGame()
    |-- if (CONFIG.fheEnabled)
    |       _startBossBattleGameFHE()
    v
_startBossBattleGameFHE():
    |-- Wallet.connect()
    |-- FHE.GameMode.initialize()
    |-- createSinglePlayerGame()  // SAME blockchain function
    |-- POST /api/me/games/boss_battle
    |       { fhe_enabled: true, fhe_game_id: gameId }
    v
Server:
    |-- gameSetupOptions.fheEnabled = true
    |-- createSinglePlayerGame(..., gameSetupOptions)
```

---

## 13. Marble System (Booster Packs)

Marbles use FHE for provably fair pack opening with 15 random values.

### Random Value Layout

| Index | Purpose | Description |
|-------|---------|-------------|
| 0-4 | Rarity | Common/Rare/Epic/Legendary roll |
| 5-9 | Card Index | Selects card from pool |
| 10-14 | Prismatic | Prismatic variant check |

### Rarity Thresholds (0-255)

| Range | Rarity | Probability |
|-------|--------|-------------|
| 0-186 | Common | 73% |
| 187-225 | Rare | 15% |
| 226-250 | Epic | 10% |
| 251-255 | Legendary | 2% |

### Prismatic Thresholds

| Rarity | Threshold | Probability |
|--------|-----------|-------------|
| Common | < 10 | ~4% |
| Rare | < 15 | ~6% |
| Epic | < 18 | ~7% |
| Legendary | < 20 | ~8% |

### Marble Flow

```
CLIENT                    MarbleRandoms               SERVER
   |                            |                        |
   |                            |                        |
   | 1. drawRandoms(marbleId, cardSetId)                 |
   +--------------------------->|                        |
   |                            |                        |
   |                            |                        |
   |                            | 15x FHE.randEuint8()   |
   |                            |                        |
   |                            |                        |
   |    TX confirmed            |                        |
   |<---------------------------+                        |
   |                            |                        |
   |                            |                        |
   | 2. getRandomHandles(marbleId)                       |
   +--------------------------->|                        |
   |                            |                        |
   |                            |                        |
   |    bytes32[15] handles     |                        |
   |<---------------------------+                        |
   |                            |                        |
   |                            |                        |
   | 3. Gateway decrypt all 15  |                        |
   |                            |                        |
   |                            |                        |
   | 4. revealRandoms(marbleId, values, proof)           |
   +--------------------------->|                        |
   |                            |                        |
   |                            |                        |
   |                            | FHE.checkSignatures()  |
   |                            | Store verified values  |
   |                            |                        |
   |                            |                        |
   |    TX confirmed            |                        |
   |<---------------------------+                        |
   |                            |                        |
   |                            |                        |
   | 5. PUT /spirit_orbs/fhe_opened/:id                  |
   |    { marble_id: "0x..." }  |                        |
   +---------------------------------------------------->|
   |                            |                        |
   |                            |                        |
   |                            |  6. isMarbleRevealed() |
   |                            |<-----------------------+
   |                            |                        |
   |                            |                        |
   |                            | 7. getVerifiedRandoms()|
   |                            |<-----------------------+
   |                            |                        |
   |                            |    8. Calculate cards  |
   |                            |       using SDK pools  |
   |                            |       Update inventory |
   |                            |                        |
   |                            |                        |
   | 9. Response: { cards: [...] }                       |
   |<----------------------------------------------------+
   |                            |                        |
   |                            |                        |
```

### Server Card Calculation

```coffeescript
# fhe_marble_verifier.coffee

calculateCardsFromRandoms: (cardSetId, rarity, index, prismatic) ->
  new_cards = []

  COMMON_THRESHOLD = 186
  RARE_THRESHOLD = 225
  EPIC_THRESHOLD = 250

  PRISMATIC_COMMON = 10
  PRISMATIC_RARE = 15
  PRISMATIC_EPIC = 18
  PRISMATIC_LEGENDARY = 20

  for i in [0...5]
    # Determine rarity
    if rarity[i] <= COMMON_THRESHOLD
      rarityType = SDK.Rarity.Common
      prismaticThreshold = PRISMATIC_COMMON
    else if rarity[i] <= RARE_THRESHOLD
      rarityType = SDK.Rarity.Rare
      prismaticThreshold = PRISMATIC_RARE
    else if rarity[i] <= EPIC_THRESHOLD
      rarityType = SDK.Rarity.Epic
      prismaticThreshold = PRISMATIC_EPIC
    else
      rarityType = SDK.Rarity.Legendary
      prismaticThreshold = PRISMATIC_LEGENDARY

    # Get card pool from CardRegistry
    cardPool = SDK.GameSession.getCardCaches()
      .getCardSet(cardSetId)
      .getRarity(rarityType)
      .getIsCollectible(true)
      .getIsPrismatic(false)
      .getCardIds()

    # Select card using index
    selectedIndex = index[i] % cardPool.length
    cardId = SDK.Cards.getBaseCardId(cardPool[selectedIndex])

    # Check prismatic
    if prismatic[i] < prismaticThreshold
      cardId = SDK.Cards.getPrismaticCardId(cardId)

    new_cards.push(cardId)

  return new_cards
```

---

## 14. Error Handling and Retry

### Cached Initial Hand for Retry

```javascript
// fheGameSession.js

// After successful blockchain TX, cache the result
self._cachedInitialHandData = {
    hand: self.myHand.slice(),
    revealedIndices: self.revealedIndices.slice()
};

// On retry, check cache first
if (self._cachedInitialHandData) {
    // Skip blockchain, just notify server
    retryNotifyServer().then(resolve).catch(reject);
    return;
}
```

### Why Cache is Needed

| Problem | Without Cache | With Cache |
|---------|---------------|------------|
| Blockchain TX succeeds | - | - |
| Server notification fails | - | - |
| User clicks Re-Decrypt | Blockchain says "Already revealed" | Skip blockchain, retry server only |

### Retry Flow

```
CLIENT: revealInitialHand()
    |
    |
    v
Blockchain: revealDrawBatch()
    |
    |-- SUCCESS
    |
    v
Cache: _cachedInitialHandData = { hand, indices }
    |
    |
    v
Server: socket.emit("fhe_initial_hand_revealed")
    |
    |-- 500 ERROR
    |
    v
EventBus: EVENTS.fhe_draw_decrypt_failed
    |
    |
    v
UI: Show Re-Decrypt button
    |
    |
    v
User clicks Re-Decrypt
    |
    |
    v
fheGameSession.js: revealInitialHand()
    |
    |-- if (_cachedInitialHandData)
    |       retryNotifyServer()  // Skip blockchain!
    |       
    v
Server: Retry notification
    |
    |-- SUCCESS
    |
    v
EventBus: EVENTS.fhe_draw_decrypt_success
```

---

## 15. Security Model

### FHE Security Properties

| Property | Guarantee |
|----------|-----------|
| Random Generation | `FHE.randEuint8()` - contract cannot predict or manipulate |
| Decryption | Only Zama Gateway KMS can decrypt |
| Proof Verification | `FHE.checkSignatures()` - cryptographic guarantee |
| Client Independence | Client calculates own cards, doesn't trust server |
| Server Independence | Server reads blockchain, doesn't trust client |

### Attack Prevention

| Attack Vector | Prevention |
|---------------|------------|
| Replay attacks | Each gameId/marbleId unique, single use |
| Front-running | Values encrypted until reveal |
| Server manipulation | Server reads, never generates randoms |
| Proof forgery | FHE.checkSignatures cryptographic verification |
| Unauthorized decrypt | Gateway checks EIP712 signature + ACL |
| Session key theft | AES-256-GCM + PIN + TTL expiry |
| Memory attacks | Decrypted key only in RAM, never persisted |

### Contract Condition Tables

**GameSession**

| Method | Condition | Result |
|--------|-----------|--------|
| `createSinglePlayerGame` | `games[gameId].player == 0` | Create / Revert "Game exists" |
| `getDrawHandles` | `games[gameId].isActive` | Return handles / Revert "Not active" |
| `getDrawHandles` | `msg.sender == player` | Continue / Revert "Not player" |
| `revealDrawBatch` | `msg.sender == player` | Continue / Revert "Not player" |
| `revealDrawBatch` | `FHE.checkSignatures()` | Store / Revert |

**MarbleRandoms**

| Method | Condition | Result |
|--------|-----------|--------|
| `drawRandoms` | `marbles[id].owner == 0` | Create / Revert "Already drawn" |
| `getRandomHandles` | `marbles[id].isDrawn` | Return / Revert "Not drawn" |
| `getRandomHandles` | `msg.sender == owner` | Continue / Revert "Not owner" |
| `revealRandoms` | `!marbles[id].isRevealed` | Continue / Revert "Already revealed" |
| `revealRandoms` | `FHE.checkSignatures()` | Store / Revert |

---

## Contract Addresses

### Sepolia

| Contract | Address |
|----------|---------|
| GameSession | `0x0Cc86698f008a6b86d1469Dcc8929E4FF7c28dBD` |
| MarbleRandoms | `0x905cA0c59588d3F64cdad12534B5C450485206cc` |
| WalletVault | `0x053E51a173b863E6495Dd1AeDCB0F9766e03f4A0` |
| CardRegistry | `0xf9EB68605c1df066fC944c28770fFF8476ADE8fc` |
| CardNFT | `0xD200776dE5A8472382F5b8b902a676E2117d7A31` |
| GameGold | `0xdB1274A736812A28b782879128f237f35fed7B81` |

### Hardhat Local

| Contract | Address |
|----------|---------|
| GameGold | `0x5FbDB2315678afecb367f032d93F642f64180aa3` |
| CardNFT | `0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512` |
| CardRegistry | `0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0` |
| GameSession | `0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9` |
| WalletVault | `0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9` |
| MarbleRandoms | `0x5FC8d32690cc91D4c39d9d3abcBD16989F875707` |

---

## View Functions Summary

| Function | Contract | Caller | Data Returned |
|----------|----------|--------|---------------|
| `getAllowedReveals(gameId)` | GameSession | Client | Number of allowed reveals |
| `getDrawHandles(gameId, count)` | GameSession | Client | Encrypted handles |
| `getVerifiedDrawOrder(gameId)` | GameSession | Server | Verified indices |
| `getRevealedCount(gameId)` | GameSession | Both | Reveal count |
| `getCurrentTurn(gameId)` | GameSession | Both | Current turn number |
| `isMarbleRevealed(marbleId)` | MarbleRandoms | Server | Boolean |
| `getVerifiedRandoms(marbleId)` | MarbleRandoms | Server | rarity/index/prismatic arrays |

---

## Transaction Summary

| Phase | TX Count | Who Sends |
|-------|----------|-----------|
| Game Creation | 1 | Client (createSinglePlayerGame) |
| Initial Hand | 1 | Client (revealDrawBatch x5) |
| Each Turn | 2 | Client (incrementTurn + revealDrawBatch) |
| Marble Draw | 1 | Client (drawRandoms) |
| Marble Reveal | 1 | Client (revealRandoms) |

**10 Turn Game Total:** 1 + 1 + (10 x 2) = 22 TX (all from client)

**Server TX Count:** 0 (only VIEW calls)
